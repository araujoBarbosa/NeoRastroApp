<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>NeoRastro ‚Äî Cadastro</title>

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline';
    connect-src 'self';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests
  ">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">

  <meta name="csrf-token" content="{{CSRF_TOKEN}}" />

  <link rel="preload" as="image" href="imagem-principal.jpg" />
// ...existing code...
  <script>
    // ‚úÖ FUNCIONALIDADE COMPLETA DO CADASTRO NEORASTRO
    
    // Vari√°veis globais
    let validacaoAtiva = false;
    
    // üëÅÔ∏è FUN√á√ÉO PARA ALTERNAR VISIBILIDADE DAS SENHAS
    function configurarAlternarSenha() {
      console.log('üîß Configurando bot√µes de alternar senha...');
      
      const botoesAlternar = document.querySelectorAll('.botao-alternar-senha');
      
      botoesAlternar.forEach((botao, index) => {
        const campoControle = botao.getAttribute('aria-controls');
        const campoSenha = document.getElementById(campoControle);
        
        if (!campoSenha) {
          console.warn(`‚ùå Campo ${campoControle} n√£o encontrado`);
          return;
        }
        
        console.log(`‚úÖ Configurando bot√£o ${index + 1} para campo ${campoControle}`);
        
        botao.addEventListener('click', function() {
          const senhaVisivel = campoSenha.type === 'text';
          
          // Alternar tipo do campo
          campoSenha.type = senhaVisivel ? 'password' : 'text';
          
          // Atualizar atributos do bot√£o
          botao.setAttribute('aria-pressed', !senhaVisivel);
          botao.setAttribute('aria-label', senhaVisivel ? 'Mostrar senha' : 'Ocultar senha');
          
          // Alterar √≠cone
          botao.textContent = senhaVisivel ? 'üëÅÔ∏è' : 'üôà';
          
          console.log(`üëÅÔ∏è Senha ${campoControle}: ${senhaVisivel ? 'ocultada' : 'mostrada'}`);
        });
      });
    }
    
    // üìä MEDIDOR DE FOR√áA DA SENHA
    function configurarMedidorForca() {
      console.log('üîß Configurando medidor de for√ßa da senha...');
      
      const campoSenha = document.getElementById('campo-senha');
      const barraProgresso = document.getElementById('forca-senha');
      const rotuloForca = document.getElementById('rotulo-forca');
      
      if (!campoSenha || !barraProgresso || !rotuloForca) {
        console.warn('‚ùå Elementos do medidor de for√ßa n√£o encontrados');
        return;
      }
      
      campoSenha.addEventListener('input', function() {
        const senha = campoSenha.value;
        let pontuacao = 0;
        let textoForca = 'Muito fraca';
        let corClasse = 'fraca';
        
        // Crit√©rios de for√ßa
        if (senha.length >= 8) pontuacao++;
        if (/[a-z]/.test(senha)) pontuacao++;
        if (/[A-Z]/.test(senha)) pontuacao++;
        if (/\d/.test(senha)) pontuacao++;
        if (/[^a-zA-Z\d]/.test(senha)) pontuacao++;
        
        // Definir texto e classe baseado na pontua√ß√£o
        switch (pontuacao) {
          case 0:
          case 1:
            textoForca = 'Muito fraca';
            corClasse = 'muito-fraca';
            break;
          case 2:
            textoForca = 'Fraca';
            corClasse = 'fraca';
            break;
          case 3:
            textoForca = 'M√©dia';
            corClasse = 'media';
            break;
          case 4:
            textoForca = 'Forte';
            corClasse = 'forte';
            break;
          case 5:
            textoForca = 'Muito forte';
            corClasse = 'muito-forte';
            break;
        }
        
        // Atualizar elementos visuais
        barraProgresso.value = pontuacao;
        rotuloForca.textContent = `For√ßa: ${textoForca}`;
        rotuloForca.className = `forca-${corClasse}`;
        
        // Validar formul√°rio ap√≥s mudan√ßa
        validarFormulario();
      });
    }
    
    // ‚úÖ VALIDA√á√ÉO DE CONFIRMA√á√ÉO DE SENHA
    function validarConfirmacaoSenha() {
      const campoSenha = document.getElementById('campo-senha');
      const campoConfirmar = document.getElementById('campo-confirmar');
      const mensagemCadastro = document.getElementById('mensagem-cadastro');
      
      if (!campoSenha || !campoConfirmar) return true;
      
      const senha = campoSenha.value;
      const confirmar = campoConfirmar.value;
      
      // Se ambos os campos t√™m conte√∫do, validar
      if (senha && confirmar) {
        if (senha !== confirmar) {
          campoConfirmar.setAttribute('aria-invalid', 'true');
          
          if (validacaoAtiva) {
            mensagemCadastro.textContent = '‚ùå As senhas n√£o coincidem';
            mensagemCadastro.className = 'mensagem erro';
          }
          
          return false;
        } else {
          campoConfirmar.removeAttribute('aria-invalid');
          
          // Limpar mensagem de erro se era sobre senhas
          if (mensagemCadastro.textContent.includes('n√£o coincidem')) {
            mensagemCadastro.textContent = '';
            mensagemCadastro.className = 'mensagem';
          }
          
          return true;
        }
      }
      
      return true;
    }
    
    // üì± FORMATA√á√ÉO DO TELEFONE
    function configurarFormatacaoTelefone() {
      const campoTelefone = document.getElementById('campo-telefone');
      
      if (!campoTelefone) return;
      
      campoTelefone.addEventListener('input', function() {
        let valor = campoTelefone.value.replace(/\D/g, '');
        
        // Limitar a 11 d√≠gitos
        if (valor.length > 11) {
          valor = valor.substring(0, 11);
        }
        
        // Aplicar formata√ß√£o
        if (valor.length >= 2) {
          valor = `(${valor.substring(0, 2)}) ${valor.substring(2)}`;
        }
        
        if (valor.length >= 10) {
          const ddd = valor.substring(0, 4);
          const parte1 = valor.substring(5, 10);
          const parte2 = valor.substring(10);
          valor = `${ddd} ${parte1}-${parte2}`;
        }
        
        campoTelefone.value = valor;
      });
    }
    
    // üîç VALIDA√á√ÉO GERAL DO FORMUL√ÅRIO
    function validarFormulario() {
      const formulario = document.getElementById('formulario-cadastro');
      const botaoCadastro = document.getElementById('botao-cadastro');
      const campoAceite = document.getElementById('campo-aceite');
      
      if (!formulario || !botaoCadastro || !campoAceite) return;
      
      // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
      const camposObrigatorios = formulario.querySelectorAll('input[required]');
      let todosPreenchidos = true;
      
      camposObrigatorios.forEach(campo => {
        if (!campo.value.trim()) {
          todosPreenchidos = false;
        }
      });
      
      // Verificar se as senhas coincidem
      const senhasValidas = validarConfirmacaoSenha();
      
      // Verificar se o formul√°rio √© v√°lido
      const formularioValido = formulario.checkValidity();
      
      // Habilitar/desabilitar bot√£o
      const podeEnviar = todosPreenchidos && senhasValidas && formularioValido && campoAceite.checked;
      botaoCadastro.disabled = !podeEnviar;
      
      return podeEnviar;
    }
    
    // üì§ PROCESSAR ENVIO DO FORMUL√ÅRIO
    function configurarEnvioFormulario() {
      const formulario = document.getElementById('formulario-cadastro');
      const botaoCadastro = document.getElementById('botao-cadastro');
      const mensagemCadastro = document.getElementById('mensagem-cadastro');
      
      if (!formulario || !botaoCadastro || !mensagemCadastro) {
        console.error('‚ùå Elementos essenciais do formul√°rio n√£o encontrados');
        return;
      }
      
      formulario.addEventListener('submit', async function(evento) {
        evento.preventDefault();
        
        console.log('üì§ Iniciando processo de cadastro...');
        
        // Limpar mensagens anteriores
        mensagemCadastro.textContent = '';
        mensagemCadastro.className = 'mensagem';
        
        // Valida√ß√£o final
        if (!validarFormulario()) {
          mensagemCadastro.textContent = '‚ùå Por favor, corrija os erros no formul√°rio';
          mensagemCadastro.className = 'mensagem erro';
          return;
        }
        
        // Estado de carregamento
        const textoOriginal = botaoCadastro.textContent;
        botaoCadastro.disabled = true;
        botaoCadastro.textContent = 'Criando conta...';
        formulario.style.opacity = '0.7';
        formulario.style.pointerEvents = 'none';
        
        try {
          // Coletar dados do formul√°rio
          const formData = new FormData(formulario);
          const dadosCadastro = {};
          
          formData.forEach((valor, chave) => {
            dadosCadastro[chave] = valor;
          });
          
          // Remover dados desnecess√°rios
          delete dadosCadastro.csrf_token;
          delete dadosCadastro.confirmar;
          
          console.log('üìã Dados coletados:', {
            nome: dadosCadastro.nome,
            email: dadosCadastro.email,
            telefone: dadosCadastro.telefone,
            empresa: dadosCadastro.empresa || '(n√£o informado)'
          });
          
          // Enviar requisi√ß√£o
          const resposta = await fetch('/api/cadastro', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(dadosCadastro)
          });
          
          console.log(`üì° Resposta recebida: ${resposta.status} ${resposta.statusText}`);
          
          const resultado = await resposta.json();
          
          if (!resposta.ok) {
            throw new Error(resultado.erro || resultado.mensagem || 'Erro desconhecido no servidor');
          }
          
          // Sucesso
          console.log('‚úÖ Cadastro realizado com sucesso:', resultado);
          
          mensagemCadastro.textContent = '‚úÖ Conta criada com sucesso! Redirecionando para o login...';
          mensagemCadastro.className = 'mensagem sucesso';
          
          // Redirecionar ap√≥s 3 segundos
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
          
        } catch (erro) {
          console.error('‚ùå Erro no cadastro:', erro);
          
          let mensagemErro = '‚ùå Erro ao criar conta. Tente novamente.';
          
          if (erro.message.includes('j√° est√° cadastrado')) {
            mensagemErro = '‚ùå Este e-mail j√° est√° cadastrado. Tente fazer login.';
          } else if (erro.message.includes('senha')) {
            mensagemErro = '‚ùå A senha deve ter pelo menos 8 caracteres.';
          } else if (erro.message) {
            mensagemErro = `‚ùå ${erro.message}`;
          }
          
          mensagemCadastro.textContent = mensagemErro;
          mensagemCadastro.className = 'mensagem erro';
          
          // Restaurar estado do formul√°rio
          botaoCadastro.disabled = false;
          botaoCadastro.textContent = textoOriginal;
          formulario.style.opacity = '';
          formulario.style.pointerEvents = '';
        }
      });
    }
    
    // üëÇ CONFIGURAR EVENT LISTENERS
    function configurarEventListeners() {
      const formulario = document.getElementById('formulario-cadastro');
      const campoSenha = document.getElementById('campo-senha');
      const campoConfirmar = document.getElementById('campo-confirmar');
      
      if (!formulario) return;
      
      // Ativar valida√ß√£o ap√≥s primeira tentativa
      formulario.addEventListener('submit', () => {
        validacaoAtiva = true;
      }, { once: true });
      
      // Valida√ß√£o em tempo real
      formulario.addEventListener('input', validarFormulario);
      formulario.addEventListener('change', validarFormulario);
      
      // Valida√ß√£o espec√≠fica das senhas
      if (campoSenha) {
        campoSenha.addEventListener('input', validarConfirmacaoSenha);
      }
      
      if (campoConfirmar) {
        campoConfirmar.addEventListener('input', validarConfirmacaoSenha);
      }
    }
    
    // üöÄ INICIALIZA√á√ÉO PRINCIPAL
    function inicializarCadastro() {
      console.log('üöÄ Inicializando sistema de cadastro NeoRastro...');
      
      // Verificar se j√° est√° logado
      const token = localStorage.getItem('neorastro_token');
      const usuario = localStorage.getItem('neorastro_usuario');
      
      if (token && usuario) {
        console.log('üë§ Usu√°rio j√° logado, redirecionando...');
        window.location.href = 'painel.html';
        return;
      }
      
      try {
        // Configurar todas as funcionalidades
        configurarAlternarSenha();
        configurarMedidorForca();
        configurarFormatacaoTelefone();
        configurarEnvioFormulario();
        configurarEventListeners();
        
        // Valida√ß√£o inicial
        validarFormulario();
        
        console.log('‚úÖ Sistema de cadastro configurado com sucesso!');
        
      } catch (erro) {
        console.error('‚ùå Erro na inicializa√ß√£o:', erro);
      }
    }
    
    // üéØ AGUARDAR CARREGAMENTO DO DOM
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarCadastro);
    } else {
      inicializarCadastro();
    }
    
  </script>
</body>
</html>